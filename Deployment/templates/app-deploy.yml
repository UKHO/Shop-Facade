parameters:
- name: Environment
  type: string
- name: AzureSubscription
  type: string
- name: LiveOrNonLive
  type: string
  default: "NonLive"  
- name: ContinueEvenIfResourcesAreGettingDestroyed
  type: boolean
  default: false
- name: Container
  type: string
- name: RunTests
  type: boolean
  default: false

jobs:
- deployment: DevDeployTerraform
  displayName: "${{parameters.Environment}} - Deploy Terraform"
  environment: "ShopFacade-${{parameters.Environment}}"
  pool: $(DeploymentPool)
  container: ${{parameters.Container}}
  workspace:
    clean: all
  strategy:
          runOnce:
            deploy:
              steps:
                - template: continuous-deployment.yml
                  parameters:
                    ContinueEvenIfResourcesAreGettingDestroyed: ${{ parameters.ContinueEvenIfResourcesAreGettingDestroyed }}
                    AzureSubscription: ${{parameters.AzureSubscription}}
                          
- deployment: DeployApp
  dependsOn: DevDeployTerraform
  displayName: "${{parameters.Environment}} - Deploy Dotnet App"
  environment: "ShopFacade-${{parameters.Environment}}"
  pool: $(WindowPool)
  #pool: $(DeploymentPool)
  #container: ${{parameters.Container}}
  workspace:
   clean: all
  variables:
    - name  : WEB_APP_NAME
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.WEB_APP_NAME'] ]
    - name  : "KeyVaultSettings.ServiceUri" 
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.keyvaulturi'] ]
    - name  : ResourceGroup
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.ResourceGroup'] ]
    - name  : WEB_APP_SLOT_NAME
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.WEB_APP_SLOT_NAME'] ]
    - name  : WEB_APP_SLOT_HOST_NAME
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.WEB_APP_SLOT_HOST_NAME'] ]
    - name  : MOCK_WEB_APP_NAME
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.MOCK_WEB_APP_NAME'] ]
    - name  : ADDS_MOCK_WEB_APP_NAME
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.ADDS_MOCK_WEB_APP_NAME'] ]
    - name  : "GraphApiConfiguration.GraphApiBaseUrl"
      value : $[ dependencies.DevDeployTerraform.outputs['DevDeployTerraform.TerraformDeploy.ADDS_MOCK_WEB_APP_NAME'] ]
  strategy:
    runOnce:
      deploy:
        steps:
          - checkout: self
            submodules: recursive
          - template: continuous-deployment-app.yml
            parameters:
              AzureSubscription: ${{parameters.AzureSubscription}}

# - deployment: functionaltests
#   dependsOn:  DeployApp
#   displayName: "${{parameters.environment}} - functional automated tests"
#   environment: "shopfacade-${{parameters.environment}}"
#   pool: $(WindowPool)
#   #pool: $(DeploymentPool)
#   #container: ${{parameters.Container}}
#   # condition: and(succeeded('deployapp'), eq( ${{parameters.runtests}} , 'true'))
#   workspace:
#    clean: all
#   variables:
#   - name: configurationpath
#     value: '$(Build.SourcesDirectory)\UKHOADDSMockService\service-configuration'
#   - name: overrideconfigurationpath
#     value: '$(Build.SourcesDirectory)\UKHOADDSMockService\override-configuration'
#     #value: '$(build.sourcesdirectory)\src\mocksssss\override-configuration'
#   strategy:
#     runOnce:
#       deploy:
#         steps:
#           # - checkout: self
#           #   submodules: recursive
#           - template: continuous-testing.yml
#             parameters:
#               azuresubscription: ${{parameters.azuresubscription}}
