parameters:
# Disable the NVD dependency check job.
- name: DisableDependencyCheck
  type: boolean
  default: false
# The Terraform Azure PowerShell container.
- name: Container
  type: string
jobs:
- job: Dependencychecker
  condition: eq('${{ parameters.DisableDependencyCheck }}', false)
  workspace:
    clean: all
  displayName: "Dependency Checker"
  steps:          
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0.x sdk'
      inputs:
        packageType: sdk
        useGlobalJson: true
        workingDirectory: '$(Build.SourcesDirectory)'

    - task: DotNetCoreCLI@2
      displayName: ".Net Core - NuGet restore non test projects only"
      inputs:
        command: "restore"
        projects: |
          **/*.csproj
          !**/*Tests.csproj
        feedsToUse: config
        noCache: true
        nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
        workingDirectory:
        packagesDirectory: 

    - template: dependency-checker/windows-dependency-checker.yaml@UKHOTemplates
      parameters:
        scanName: Shop-Facade
        scanPath: '$(Build.SourcesDirectory)\src'
        suppressionPath: '$(Build.SourcesDirectory)\NVDSuppressions.xml'

- job: UnitTestsAndCodeCoverage
  workspace:
    clean: all
  displayName: "Dotnet Test and Publish Code Coverage"
  steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0.x sdk'
      inputs:
        packagetype: sdk
        useglobaljson: true
        workingdirectory: '$(build.sourcesdirectory)\src'

    - task: DotNetCoreCLI@2
      displayName: ".Net Core - NuGet restore test projects only"
      inputs:
        command: "restore"
        projects: "**/*Tests.csproj"
        feedsToUse: config
        noCache: true
        nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
        workingDirectory: '$(Build.SourcesDirectory)'
        packagesDirectory: '$(Build.SourcesDirectory)\packagesForTests'

    - task: DotNetCoreCLI@2
      displayName: "Dotnet test - ShopFacade API Unit Tests"
      inputs:
        command: "test"
        projects: |
          **/*.UnitTests.csproj
        arguments: '--configuration $(BuildConfiguration) --settings "$(Build.SourcesDirectory)\test.runsettings" /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura'
        publishTestResults: true
        testRunTitle: "UnitTests"

    - task: publishcodecoverageresults@2
      displayName: "publish code coverage report for build quality checks"
      inputs:
        summaryfilelocation: '$(Build.SourcesDirectory)/**/coverage.cobertura.xml'              
        failIfCoverageEmpty: true

    - task: PowerShell@2
      displayName: "Generate code coverage report"
      inputs:
        targetType: filePath
        filePath: '$(Build.SourcesDirectory)\CodeCoverageReport.ps1'
        arguments: '-source "$(Build.SourcesDirectory)" -reportFolder "$(Build.ArtifactStagingDirectory)"'

    - task: PublishBuildArtifacts@1
      displayName: "Publish Code coverage"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)/codecoveragereport"
        ArtifactName: codecoveragereport

    - task: BuildQualityChecks@9
      displayName: "Code coverage fails if threshold not meet"            
      inputs:
        checkCoverage: true
        coverageFailOption: 'fixed'
        coverageType: 'lines'
        coverageThreshold: '$(CoverageThresholdLimit)'
 
- job: BuildAndPublishAPI
  workspace:
    clean: all
  displayName: "Dotnet Build publish API"
  steps:
    - task: PowerShell@2
      displayName: "Set assembly version numbers based on build ID"
      inputs:
        targetType: filePath
        filePath: '$(Build.SourcesDirectory)\Apply-AssemblyVersionAndDefaults.ps1'
        arguments: '-buildNumber "$(Build.BuildNumber)" -solutionDirectory "$(Build.SourcesDirectory)\src\UKHO.ShopFacade.API\" -UKHOAssemblyCompany "$env:UKHOAssemblyCompany" -UKHOAssemblyCopyright "$(UKHOAssemblyCopyright)" -UKHOAssemblyVersionPrefix "$env:UKHOAssemblyVersionPrefix" -UKHOAssemblyProduct "$env:UKHOAssemblyProduct"'

    - task: UseDotNet@2
      displayName: 'Use .NET 8.0.x sdk'
      inputs:
        packageType: sdk
        useGlobalJson: true
        workingDirectory: '$(Build.SourcesDirectory)\src'
              
    - task: DotNetCoreCLI@2
      displayName: ".Net Core - NuGet restore for non test projects only"
      inputs:
        command: "restore"
        projects: '**/*.csproj'
        feedsToUse: config
        noCache: true
        nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
        workingDirectory: '$(Build.SourcesDirectory)\src'
        packagesDirectory: '$(Build.SourcesDirectory)\src\packages'

    - task: DotNetCoreCLI@2
      displayName: "dotnet build task"
      inputs:
        command: "build"
        projects: '**/*.csproj'
        arguments: '--configuration $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: "Publish Shop Facade Service API "
      inputs:
        command: "publish"
        publishWebProjects: false
        projects: '**/*UKHO.ShopFacade.API.csproj'
        arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\UKHO.ShopFacade.API'
        zipAfterPublish: false
        modifyOutputPath: false

    - task: ArchiveFiles@2
      displayName: "Zip Shop Facade Service"
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/UKHO.ShopFacade.API/'
        includeRootFolder: false
        archiveType: "zip"
        archiveFile: '$(Build.ArtifactStagingDirectory)/UKHO.ShopFacade.API/UKHOShopFacadeServiceAPI.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: "Publish terraform Artifacts"
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\Deployment'
        ArtifactName: terraformartifact   

    - task: PublishBuildArtifacts@1
      displayName: "Publish WebAPI Artifact"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\UKHO.ShopFacade.API/UKHOShopFacadeServiceAPI.zip'
        ArtifactName: UKHOShopFacadeServiceAPI


- job: BuildAndPublishADDSMockServices
  workspace:
    clean: all
  displayName: "Dotnet Build publish ADDS Mock Services"        
  steps:
    - checkout: self
      submodules: true

    - script: git submodule update --init --force --remote
  
- job: BuildAndPublishADDSMockService
  workspace:
    clean: all
  displayName: "Dotnet Build publish ADDS Mock Service"
  steps:
    - checkout: self
      submodules: true

    - script: git submodule update --init --force --remote
 
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0.x sdk'
      inputs:
        packageType: sdk
        useGlobalJson: true
        workingDirectory: '$(Build.SourcesDirectory)\src'

    # - task: PowerShell@2
    #   inputs:
    #     targetType: 'inline'
    #     script: |
    #       Get-ChildItem "$(Build.SourcesDirectory)\src\MockSSSSS"
            
    #       Get-ChildItem "$(Build.SourcesDirectory)\src" -Recurse -File
              
    - task: DotNetCoreCLI@2
      displayName: ".Net Core - NuGet restore for non test projects only"
      inputs:
        command: "restore"
        projects: '**/*ADDSMock.csproj'
        feedsToUse: config
        noCache: true
        nugetConfigPath: '$(Build.SourcesDirectory)\src\MockSSSSS\BuildNuget.config'
        workingDirectory: '$(Build.SourcesDirectory)\src\MockSSSSS\src\ADDSMock'
        packagesDirectory: '$(Build.SourcesDirectory)\ADDSMock\packages'

    - task: CopyFiles@2
      displayName: "Copy additional configuration directories"
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)\src\MockSSSSS\override-configuration'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService\override-configuration'

    - task: CopyFiles@2
      displayName: "Copy additional configuration directories"
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)\src\MockSSSSS\service-configuration'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService\service-configuration'

    - task: PowerShell@2
      displayName: "Set overrideconfigurationpath and configurationpath pipeline variables"
      inputs:
        targetType: 'inline'
        script: |
          # Find the service-configuration folder
          $serviceConfigurationFolder = Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService" -Recurse -Directory | Where-Object { $_.Name -eq "service-configuration" }

          if ($serviceConfigurationFolder) {
              $serviceConfigPath = $serviceConfigurationFolder.FullName
              Write-Host "Found service-configuration folder: $serviceConfigPath"
              Write-Host "##vso[task.setvariable variable=configurationpath]$serviceConfigPath"
          } else {
              Write-Host "Error: service-configuration folder not found!"
              exit 1  # Fail pipeline if folder is missing
          }

          # Find the override-configuration folder
          $overrideConfigurationFolder = Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService" -Recurse -Directory | Where-Object { $_.Name -eq "override-configuration" }

          if ($overrideConfigurationFolder) {
              $overrideConfigPath = $overrideConfigurationFolder.FullName
              Write-Host "Found override-configuration folder: $overrideConfigPath"
              Write-Host "##vso[task.setvariable variable=overrideconfigurationpath]$overrideConfigPath"
          } else {
              Write-Host "Error: override-configuration folder not found!"
              exit 1  # Fail pipeline if folder is missing
          }

          # Output confirmation
          Write-Host "service-configuration is set to: $serviceConfigPath"
          Write-Host "override-configuration is set to: $overrideConfigPath"



    # - task: FileTransform@2
    #   displayName: "File Transform: Mock Service Settings"
    #   inputs:
    #     folderPath: '$(Build.SourcesDirectory)\src\MockSSSSS\src\ADDSMock'
    #     xmlTransformationRules: ''
    #     jsonTargetFiles: '**/mock-configuration.json'

    - task: PowerShell@2
      displayName: "Update mock-configuration.json with paths"
      inputs:
        targetType: 'inline'
        script: |
          $mockConfigPath = "$(Build.SourcesDirectory)\src\MockSSSSS\src\ADDSMock\mock-configuration.json"
          $configPath = "$(configurationpath)"
          $overrideConfigPath = "$(overrideconfigurationpath)"
          $useSsl = $false

          if (Test-Path $mockConfigPath) {
              $json = Get-Content $mockConfigPath -Raw | ConvertFrom-Json
              $json.configurationPath = $configPath
              $json.overrideConfigurationPath = $overrideConfigPath
              $json.useSsl = $useSsl
              $json | ConvertTo-Json -Depth 32 | Set-Content $mockConfigPath
              Write-Host "Updated mock-configuration.json with paths."
          } else {
              Write-Host "Error: mock-configuration.json not found!"
              exit 1  # Fail pipeline if file is missing
          }

    - task: PowerShell@2
      condition: always()
      inputs:
   
        targetType: 'inline'
        script: |
          $file = Get-ChildItem -Path "$(Build.SourcesDirectory)\src\MockSSSSS\src\ADDSMock" -Recurse -File -Filter "mock-configuration.json" | Select-Object -First 1
       
          if ($file) {
              # Read and print the content of the found file
              $content = Get-Content $file.FullName -Raw
              Write-Host "File Found: $($file.FullName)"
              Write-Host "Content: $content"
          } else {
              Write-Host "File 'mock-configuration.json' not found in $(Build.SourcesDirectory)"
          }

    - task: DotNetCoreCLI@2
      displayName: "dotnet build task"
      inputs:
        command: "build"
        projects: '**/*ADDSMock.csproj'
        arguments: '--configuration $(BuildConfiguration)'

    - task: DotNetCoreCLI@2
      displayName: "Publish ADDS Mock Service"
      inputs:
        command: "publish"
        publishWebProjects: false
        projects: '**/*ADDSMock.csproj'
        arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService'
        zipAfterPublish: false
        modifyOutputPath: false

    - task: CopyFiles@2
      displayName: "Copy additional configuration directories"
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)\src\MockSSSSS\override-configuration'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService\override-configuration'

    - task: CopyFiles@2
      displayName: "Copy additional configuration directories"
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)\src\MockSSSSS\service-configuration'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService\service-configuration'

    - task: ArchiveFiles@2
      displayName: "Zip ADDS Mock Service"
      inputs:
        rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/UKHO.ADDS.MockService/'
        includeRootFolder: false
        archiveType: "zip"
        archiveFile: '$(Build.ArtifactStagingDirectory)/UKHO.ADDS.MockService/UKHOADDSMockService.zip'
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: "Publish ADDS Mock Service Artifact"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\UKHO.ADDS.MockService/UKHOADDSMockService.zip'
        ArtifactName: UKHOADDSMockService

- job: PublishFunctionalTests
  workspace:
    clean: all
  displayName: "Publish FunctionalTests Artifact"
  steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0.x sdk'
      inputs:
        packageType: sdk
        useGlobalJson: true
        workingDirectory: '$(Build.SourcesDirectory)\src'

    - task: DotNetCoreCLI@2
      displayName: ".Net Core - NuGet restore for non test projects only"
      inputs:
        command: "restore"
        projects: |
          **/*.csproj
          !**/UKHO.ShopFacade.MockService.csproj
        feedsToUse: config
        noCache: true
        nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
        workingDirectory: '$(Build.SourcesDirectory)\src'
        packagesDirectory: '$(Build.SourcesDirectory)\src\packages'

    - task: DotNetCoreCLI@2
      displayName: "Publish Functional Test Code "
      inputs:
        command: "publish"
        publishWebProjects: false
        projects: '$(Build.SourcesDirectory)\tests\UKHO.ShopFacade.API.FunctionalTests\UKHO.ShopFacade.API.FunctionalTests.csproj'
        arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)\UKHO.ShopFacade.API.FunctionalTests'
        workingDirectory: '$(Build.SourcesDirectory)\tests\UKHO.ShopFacade.API.FunctionalTests'
        zipAfterPublish: false
        modifyOutputPath: trues

    - task: PublishBuildArtifacts@1
      displayName: "Publish Functional test Artifact"
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\UKHO.ShopFacade.API.FunctionalTests'
        ArtifactName: functionaltests
