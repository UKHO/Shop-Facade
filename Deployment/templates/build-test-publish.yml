parameters:
# Disable the NVD dependency check job.
- name: DisableDependencyCheck
  type: boolean
  default: false

jobs:
- job: Dependencychecker
  condition: eq('${{ parameters.DisableDependencyCheck }}', false)
  workspace:
    clean: all
  displayName: "Dependencychecker"
  steps:          
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0.x sdk'
      inputs:
        packageType: sdk
        useGlobalJson: true
        workingDirectory: '$(Build.SourcesDirectory)'

    - task: DotNetCoreCLI@2
      displayName: ".Net Core - NuGet restore non test projects only"
      inputs:
        command: "restore"
        projects: |
          **/*.csproj
          !**/*Tests.csproj
        feedsToUse: config
        noCache: true
        nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
        workingDirectory:
        packagesDirectory: 

    - template: dependency-checker/windows-dependency-checker.yaml@UKHOTemplates
      parameters:
        scanName: Shop-Facade
        scanPath: '$(Build.SourcesDirectory)\src'
        suppressionPath: '$(Build.SourcesDirectory)\NVDSuppressions.xml'

- job: UnitTestsAndCodeCoverage
  workspace:
    clean: all
  displayName: "Dotnet Test and Publish Code Coverage"
  steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0.x sdk'
      inputs:
        packagetype: sdk
        useglobaljson: true
        workingdirectory: '$(build.sourcesdirectory)\src'

    - task: DotNetCoreCLI@2
      displayName: ".Net Core - NuGet restore test projects only"
      inputs:
        command: "restore"
        projects: "**/*Tests.csproj"
        feedsToUse: config
        noCache: true
        nugetConfigPath: '$(Build.SourcesDirectory)\BuildNuget.config'
        workingDirectory: '$(Build.SourcesDirectory)'
        packagesDirectory: '$(Build.SourcesDirectory)\packagesForTests'

    - task: DotNetCoreCLI@2
      displayName: "Dotnet test - ShopFacade API Unit Tests"
      inputs:
        command: "test"
        projects: |
          **/*.UnitTests.csproj
        arguments: '--configuration $(BuildConfiguration) --settings "$(Build.SourcesDirectory)\test.runsettings" /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura'
        publishTestResults: true
        testRunTitle: "UnitTests"

    - task: publishcodecoverageresults@2
      displayName: "publish code coverage report for build quality checks"
      inputs:
        summaryfilelocation: '$(Build.SourcesDirectory)/**/coverage.cobertura.xml'              
        failIfCoverageEmpty: true

    - task: PowerShell@2
      displayName: "Generate code coverage report"
      inputs:
        targetType: filePath
        filePath: '$(Build.SourcesDirectory)\CodeCoverageReport.ps1'
        arguments: '-source "$(Build.SourcesDirectory)" -reportFolder "$(Build.ArtifactStagingDirectory)"'

    - task: PublishBuildArtifacts@1
      displayName: "Publish Code coverage"
      inputs:
        PathtoPublish: "$(Build.ArtifactStagingDirectory)/codecoveragereport"
        ArtifactName: codecoveragereport

    - task: BuildQualityChecks@9
      displayName: "Code coverage fails if threshold not meet"            
      inputs:
        checkCoverage: true
        coverageFailOption: 'fixed'
        coverageType: 'lines'
        coverageThreshold: '$(CoverageThresholdLimit)'
 
- job: BuildAndPublishAPI
  workspace:
    clean: all
  displayName: "Dotnet Build publish API"

