parameters:
  - name: AzureSubscription
    type: string    

steps:
  - task: DownloadBuildArtifacts@0
    displayName: "Download Functional test Artifact"
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'functionaltests'
      downloadPath: '$(Build.SourcesDirectory)'


  - task: DownloadBuildArtifacts@0
    displayName: "Download ADDSMock Artifact"
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'UKHOADDSMockService'
      downloadPath: '$(Build.SourcesDirectory)'

  # - task: FileTransform@2
  #   displayName: "File Transform: functionaltests"
  #   inputs:
  #      folderPath: '$(Build.SourcesDirectory)/functionaltests/'
  #      xmlTransformationRules:
  #      jsonTargetFiles: '**/appsettings.json'

  - task: UseDotNet@2
    displayName: 'Use .NET 8.0.x sdk'
    inputs:
      packageType: sdk
      useGlobalJson: true
      workingDirectory: '$(Build.SourcesDirectory)'


  # - task: PowerShell@2
  #   inputs:
  #     targetType: 'inline'
  #     script: |
  #       # Define the module name you're checking for
  #       $moduleName = "NetTCPIP"
        
  #       # Check if the module is already available
  #       $module = Get-Module -ListAvailable -Name $moduleName
        
  #       if ($module) {
  #           Write-Host "Module '$moduleName' is already installed:"
  #           $module | Format-List Name, Path, Version
  #       } else {
  #           Write-Host "Module '$moduleName' is not installed. Installing now..."
        
  #           # If the module is not found, attempt to install it from PowerShell Gallery
  #           try {
  #               # Check if the module is available on PowerShell Gallery
  #               Install-Module -Name $moduleName -Force -Scope CurrentUser
  #               Write-Host "Module '$moduleName' has been installed successfully."
  #           } catch {
  #               Write-Host "An error occurred while trying to install the module '$moduleName'. Error: $_"
  #           }
  #       }



  - task: PowerShell@2
    displayName: Get a url for testing
    name: getUrl
    inputs:
      targetType: filePath
      filePath: '$(Build.SourcesDirectory)/src/MockSSSSS/Pipeline/GetLocalHostUrl.ps1'


  - task: filetransform@2
    displayName: file transform - mock settings
    inputs:
      folderpath: '$(Pipeline.Workspace)/UKHOADDSMockService/*.zip'
      xmltransformationrules: ''
      enablexmltransform: false
      jsontargetfiles: '**\mock-configuration.json'

  - task: DotNetCoreCLI@2
    displayName: "Run Functional tests"
    inputs:
      command: "test"
      projects: |
          **/*FunctionalTest*.dll
          !**/*TestAdapter.dll
          !**/obj/**
      testRunTitle: "$(Environment)-AutomationTests"
      workingDirectory: '$(Build.SourcesDirectory)/functionaltests'
