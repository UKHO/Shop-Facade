parameters:
  - name: AzureSubscription
    type: string    

steps:
  - task: DownloadBuildArtifacts@0
    displayName: "Download Functional test Artifact"
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'functionaltests'
      downloadPath: '$(Build.SourcesDirectory)'

  - task: FileTransform@2
    displayName: "File Transform: functionaltests"
    inputs:
       folderPath: '$(Build.SourcesDirectory)/functionaltests/'
       xmlTransformationRules:
       jsonTargetFiles: '**/appsettings.json'

  - task: UseDotNet@2
    displayName: 'Use .NET 8.0.x sdk'
    inputs:
      packageType: sdk
      useGlobalJson: true
      workingDirectory: '$(Build.SourcesDirectory)'

  - task: PowerShell@2
    displayName: Get a url for testing
    name: getUrl
    inputs:
      targetType: filePath
      filePath: '$(Build.SourcesDirectory)\src\MockSSSSS\Pipeline\GetLocalHostUrl.ps1'

  - task: FileTransform@2
    displayName: File transform - mock settings
    inputs:
      folderPath: '$(Build.BinariesDirectory)\Mock'
      xmlTransformationRules: ''
      enableXmlTransform: false
      jsonTargetFiles: '**\mock-configuration.json'

  - task: DotNetCoreCLI@2
    displayName: "Run Functional tests"
    inputs:
      command: "test"
      projects: |
          **/*FunctionalTest*.dll
          !**/*TestAdapter.dll
          !**/obj/**
      testRunTitle: "$(Environment)-AutomationTests"
      workingDirectory: '$(Build.SourcesDirectory)/functionaltests'
