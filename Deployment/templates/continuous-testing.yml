parameters:
  - name: AzureSubscription
    type: string    

steps:
  - task: DownloadBuildArtifacts@0
    displayName: "Download Functional test Artifact"
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'functionaltests'
      downloadPath: '$(Build.SourcesDirectory)'


  - task: DownloadBuildArtifacts@0
    displayName: "Download ADDSMock Artifact"
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'UKHOADDSMockService'
      downloadPath: '$(Build.SourcesDirectory)'

  # - task: FileTransform@2
  #   displayName: "File Transform: functionaltests"
  #   inputs:
  #      folderPath: '$(Build.SourcesDirectory)/functionaltests/'
  #      xmlTransformationRules:
  #      jsonTargetFiles: '**/appsettings.json'

  - task: UseDotNet@2
    displayName: 'Use .NET 8.0.x sdk'
    inputs:
      packageType: sdk
      useGlobalJson: true
      workingDirectory: '$(Build.SourcesDirectory)'

  - task: PowerShell@2
    displayName: Get a path for Service and Override Configuration
    inputs:
      targetType: 'inline'
      script: |
        # Find and print the path of the "service-configuration" folder
        $folderPath = Get-ChildItem -Path $(Build.SourcesDirectory) -Recurse -Directory -Filter "service-configuration" | Select-Object -ExpandProperty FullName
        Write-Host "Service Configuration Path: $folderPath"
              
        # Print the pipeline variable "service-configuration"
        Write-Host "Pipeline Variable 'service-configuration': $env:ConfigurationPath"
              
        # Find and print the path of the "override-configuration" folder
        $folderPath = Get-ChildItem -Path $(Build.SourcesDirectory) -Recurse -Directory -Filter "override-configuration" | Select-Object -ExpandProperty FullName
        Write-Host "override-configuration Path: $folderPath"
              
        # Print the pipeline variable "override-configuration"
        Write-Host "Pipeline Variable 'service-configuration': $env:OverrideConfigurationPath"

  - task: filetransform@2
    displayName: file transform - mock settings
    inputs:
      folderpath: '$(Pipeline.Workspace)/UKHOADDSMockService/*.zip'
      xmltransformationrules: ''
      enablexmltransform: false
      jsontargetfiles: '**\mock-configuration.json'

  - task: PowerShell@2
    displayName: View mock-configuration.json
    condition: always()
    inputs:
      targetType: inline
      script: |
        Get-Content '$(Build.SourcesDirectory)\src\MockSSSSS\src\ADDSMock\mock-configuration.json'

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        # Define the path to the downloaded ZIP file
        # $zipFile = "$(Build.ArtifactStagingDirectory)\UKHOADDSMockService\UKHOADDSMockService.zip"  # Replace with actual ZIP file path
        # $extractPath = "$(Build.ArtifactStagingDirectory)\extracted"  # Path where ZIP will be extracted



        # Check if the ZIP file exists
        # if (-Not (Test-Path $zipFile)) {
        #   Write-Error "The specified ZIP file was not found: $zipFile"
        #   exit 1
        # }

        $extractPath = "$(Build.SourcesDirectory)\src\MockSSSSS"

        # Create the directory for extraction if it doesn't exist
        if (-Not (Test-Path -Path $extractPath)) {
            New-Item -ItemType Directory -Force -Path $extractPath
        }

        # # Extract the ZIP file
        # Write-Host "Extracting ZIP file..."
        # Expand-Archive -Path $zipFile -DestinationPath $extractPath -Force

        # List files in the extracted folder (optional, for debugging purposes)
        Write-Host "Listing files in extracted folder:"
        Get-ChildItem -Path $extractPath -Recurse | ForEach-Object { Write-Host $_.FullName }

        # Find the first executable file (.exe) in the extracted folder
        $exeFiles = Get-ChildItem -Path $extractPath -Recurse -Filter "*.exe"

        if ($exeFiles) {
            Write-Host "Found executable file: $($exeFiles[0].FullName)"
            
            # Execute the first found executable file
            $exePath = $exeFiles[0].FullName
            Write-Host "Executing $exePath"
            Start-Process -FilePath $exePath -Wait -NoNewWindow  # Wait for the process to finish
            
        } else {
            Write-Host "No executable files found in the ZIP artifact."
        }

  - task: PowerShell@2
    displayName: Get a url for testing
    name: getUrl
    inputs:
      targetType: filePath
      filePath: '$(Build.SourcesDirectory)/src/MockSSSSS/Pipeline/GetLocalHostUrl.ps1'

  - task: FileTransform@2
    displayName: "File Transform: functionaltests"
    inputs:
       folderPath: '$(Build.SourcesDirectory)/functionaltests/'
       xmlTransformationRules:
       jsonTargetFiles: '**/appsettings.json'

  - task: DotNetCoreCLI@2
    displayName: "Run Functional tests"
    inputs:
      command: "test"
      projects: |
          **/*FunctionalTest*.dll
          !**/*TestAdapter.dll
          !**/obj/**
      testRunTitle: "$(Environment)-AutomationTests"
      workingDirectory: '$(Build.SourcesDirectory)/functionaltests'
